{"version":3,"file":"zerxzLib.js","mappings":"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","sources":["webpack://extension-zerxz-lib/webpack/bootstrap","webpack://extension-zerxz-lib/webpack/runtime/define property getters","webpack://extension-zerxz-lib/webpack/runtime/hasOwnProperty shorthand","webpack://extension-zerxz-lib/external module \"../../../../../script.js\"","webpack://extension-zerxz-lib/external module \"../../../../../scripts/secrets.js\"","webpack://extension-zerxz-lib/external module \"../../../../../scripts/openai.js\"","webpack://extension-zerxz-lib/external module \"../../../../../scripts/popup.js\"","webpack://extension-zerxz-lib/./src/utils/gemini.ts","webpack://extension-zerxz-lib/./src/index.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","var x = (y) => {\n\tvar x = {}; __webpack_require__.d(x, y); return x\n} \nvar y = (x) => (() => (x))\nconst __WEBPACK_NAMESPACE_OBJECT__ = x({ [\"eventSource\"]: () => (__WEBPACK_EXTERNAL_MODULE__script_js_588e7203__.eventSource), [\"event_types\"]: () => (__WEBPACK_EXTERNAL_MODULE__script_js_588e7203__.event_types), [\"getRequestHeaders\"]: () => (__WEBPACK_EXTERNAL_MODULE__script_js_588e7203__.getRequestHeaders), [\"saveSettingsDebounced\"]: () => (__WEBPACK_EXTERNAL_MODULE__script_js_588e7203__.saveSettingsDebounced) });","var x = (y) => {\n\tvar x = {}; __webpack_require__.d(x, y); return x\n} \nvar y = (x) => (() => (x))\nconst __WEBPACK_NAMESPACE_OBJECT__ = x({ [\"updateSecretDisplay\"]: () => (__WEBPACK_EXTERNAL_MODULE__scripts_secrets_js_e26d24e7__.updateSecretDisplay), [\"writeSecret\"]: () => (__WEBPACK_EXTERNAL_MODULE__scripts_secrets_js_e26d24e7__.writeSecret) });","var x = (y) => {\n\tvar x = {}; __webpack_require__.d(x, y); return x\n} \nvar y = (x) => (() => (x))\nconst __WEBPACK_NAMESPACE_OBJECT__ = x({ [\"oai_settings\"]: () => (__WEBPACK_EXTERNAL_MODULE__scripts_openai_js_991751fb__.oai_settings) });","var x = (y) => {\n\tvar x = {}; __webpack_require__.d(x, y); return x\n} \nvar y = (x) => (() => (x))\nconst __WEBPACK_NAMESPACE_OBJECT__ = x({ [\"POPUP_TYPE\"]: () => (__WEBPACK_EXTERNAL_MODULE__scripts_popup_js_d782a329__.POPUP_TYPE), [\"callGenericPopup\"]: () => (__WEBPACK_EXTERNAL_MODULE__scripts_popup_js_d782a329__.callGenericPopup) });","import { oai_settings } from \"@silly-tavern/scripts/openai\";\nimport { callGenericPopup, POPUP_TYPE } from \"@silly-tavern/scripts/popup\";\ninterface GeminiModel {\n    description: string;\n    displayName: string;\n    inputTokenLimit: number;\n    maxTemperature: number;\n    name: string;\n    outputTokenLimit: number;\n    supportedGenerationMethods: string[];\n    temperature: number;\n    topK: number;\n    topP: number;\n    version: string;\n}\ninterface GeminiResponse {\n    models: GeminiModel[];\n}\n\nexport async function getGeminiModel(key: string) {\n    try {\n        const result = await fetch(\n            `https://generativelanguage.googleapis.com/v1beta/models/?key=${key}`,\n        );\n        const data = (await result.json()) as GeminiResponse;\n        if (!data?.models) {\n            return [];\n        }\n        console.log(data);\n        return data.models\n            .filter((model) => model.name.includes(\"gemini\"))\n            .map((modelData) => {\n                const model = modelData.name.replace(\"models/\", \"\");\n                const name = modelData.displayName;\n\n                return {\n                    name,\n                    model,\n                };\n            });\n    } catch (e) {\n        console.error(e);\n        return [];\n    }\n}\n\nexport const GEMINI_SOURCES = [\"makersuite\", \"aistudio\"];\n\nexport const isGeminiSource = () =>\n    GEMINI_SOURCES.includes(oai_settings.chat_completion_source);\n\nexport function throwGeminiError(text = \"\") {\n\n    callGenericPopup(`\n\t\t\t\t${text}\n\t\t\t\t<table class=\"responsiveTable\">\n\t\t\t\t\t<thead>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<th>报错</th>\n\t\t\t\t\t\t\t<th>原因或解决方案</th>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</thead>\n\t\t\t\t\t<tbody>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>429/Resource has been exhausted</td>\n\t\t\t\t\t\t\t<td>撞到速率上限了，请等一会，若还是出现此报错请将最大上下文调整至 50k 以下</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Internal Server Error</td>\n\t\t\t\t\t\t\t<td>手机端遇到请换成 clash，不要使用类如**VPN、** 加速器等第三方梯子软件，pc 端用户请打开服务模式和 tun 模式，若仍出现此报错需要检查一下反向代理-代理地址中是否留空，若有地址请删掉</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>User location is not supported for the API use.</td>\n\t\t\t\t\t\t\t<td>节点处于被限制的国家，请更换节点(美国最优先，请勿选择欧洲、中国香港、俄罗斯等地区)</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Too Many Requests</td>\n\t\t\t\t\t\t\t<td>重刷过于频繁，等待一分钟，若无效则本日请求已达上限</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Bad request</td>\n\t\t\t\t\t\t\t<td>网络环境出错或 API 已死（账号或项目被封禁）</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>API key expired. Please renew the API key</td>\n\t\t\t\t\t\t\t<td>API key 已过期或被删除</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>The model is overloaded. Please try later</td>\n\t\t\t\t\t\t\t<td>此模型暂时闭馆微调，暂停开放，请换用别的模型或等待一段时间</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Please use a valid role: user, model.</td>\n\t\t\t\t\t\t\t<td>你使用了需要打补丁的预设，请换不需要补丁的预设或打补丁</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>User location is not supported for the API use without a billing account linked.</td>\n\t\t\t\t\t\t\t<td>处在 Google 政策限制免费层级的地区(如英国、意大利)</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>API key not valid. Please pass a valid API key</td>\n\t\t\t\t\t\t\t<td>API 返回错误，检查 API 是否可用</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Permission denied: Consumer has been suspended.</td>\n\t\t\t\t\t\t\t<td>谷歌账号被封禁</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>MakerSuite API returned no candidate</td>\n\t\t\t\t\t\t\t<td>Prompt was blocked due to : OTHER 本次输出被截断，请关闭流式传输</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Not Found</td>\n\t\t\t\t\t\t\t<td>模型选择错误，请不要选择除 Gemini 系外的模型或 Gemini Ultra</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>MakerSuite Candidate text empty</td>\n\t\t\t\t\t\t\t<td>还是截断，解决方法有很多，关闭一些全局世界书/更改输入内容/换版本更新一点的预设</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>403/Forbidden</td>\n\t\t\t\t\t\t\t<td>账号或项目被封禁，API key 无法调用</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</tbody>\n\t\t\t\t</table>\n\n\t\t\t\t<h2>出现其它未知报错无法解决请在群内(433695739)提问</h2>\n\t\t\t`, POPUP_TYPE.TEXT, \"\", {\n        large: true,\n        wide: true,\n        allowVerticalScrolling: true,\n    });\n}\n","import {\n\teventSource,\n\tevent_types,\n\tsaveSettingsDebounced,\n\tgetRequestHeaders,\n} from \"@silly-tavern/script\";;\nimport {\n\tsecret_state,\n\tupdateSecretDisplay,\n\twriteSecret,\n} from \"@silly-tavern/scripts/secrets\";\nimport { oai_settings } from \"@silly-tavern/scripts/openai\";\nimport { getGeminiModel, isGeminiSource, throwGeminiError } from \"utils/index\";\nimport { callGenericPopup, POPUP_TYPE } from \"@silly-tavern/scripts/popup\";\nlet switchState = localStorage.getItem(\"switch_key_maker_suite\") === \"true\";\nlet throwGeminiErrorState = localStorage.getItem(\"throw_gemini_error\") !== \"true\";\ninterface Model {\n\tname: string;\n\tmodel: string;\n}\nexport default async function init(secrets: Record<string, string>) {\n\tif (!secrets) {\n\t\treturn;\n\t}\n\tconst modelStr = JSON.parse(secrets.models_makersuite ?? \"[]\") as Model[];\n\tconst api_key = secrets.api_key_makersuite ?? \"\";\n\tconsole.log(\"ZerxzLib init\");\n\tconst optgroup = $(\"#model_google_select > optgroup\");\n\tconsole.log(\"optgroup\", optgroup);\n\tconst primaryVersions = optgroup[0];\n\tconst subVersions = optgroup[1];\n\tconsole.log(\"subVersions\", subVersions);\n\tconst subVersionsArray = Array.from(\n\t\tsubVersions.children,\n\t) as HTMLOptionElement[];\n\tconst primaryVersionsArray = Array.from(\n\t\tprimaryVersions.children,\n\t) as HTMLOptionElement[];\n\tconsole.log(\"subVersionsArray\", subVersionsArray);\n\tconst subVersionsValues = subVersionsArray.map((el) => el.value);\n\tconst primaryVersionsValues = primaryVersionsArray.map((el) => el.value);\n\tconst originalVersions = [\n\t\t...primaryVersionsValues,\n\t\t...subVersionsValues,\n\t].flat();\n\tconst cachedVersions = modelStr.map((model) => model.model);\n\t// 判断是否初次加载\n\tif (modelStr.length > 0) {\n\t\tfor (const model of modelStr) {\n\t\t\tif (originalVersions.includes(model.model)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst option = document.createElement(\"option\");\n\t\t\toption.value = model.model;\n\t\t\toption.text = `${model.name}(${model.model})`;\n\t\t\tsubVersions.appendChild(option);\n\t\t}\n\t}\n\tconst geminiModels = await getGeminiModel(api_key);\n\tconsole.log(\"geminiModels\", geminiModels);\n\tconst geminiModelOptions = geminiModels.filter(\n\t\t(model) =>\n\t\t\t!originalVersions.includes(model.model) &&\n\t\t\t!cachedVersions.includes(model.model),\n\t);\n\n\tif (geminiModelOptions.length === 0) {\n\t\tconsole.log(\"没有新的模型\");\n\t} else {\n\t\tconsole.log(\"geminiModelOptions\", geminiModelOptions);\n\t\tfor (const model of geminiModelOptions) {\n\t\t\tconst option = document.createElement(\"option\");\n\t\t\toption.value = model.model;\n\t\t\toption.text = `${model.name}(${model.model})`;\n\t\t\tsubVersions.appendChild(option);\n\t\t}\n\t\tsaveKey(\"models_makersuite\", JSON.stringify(geminiModelOptions));\n\t}\n\tconst uniqueModels = new Set([...originalVersions, ...cachedVersions, ...geminiModelOptions.map((model) => model.model)]);\n\tif (GOOGLE_SOURCES.includes(oai_settings.chat_completion_source) && !!secrets.api_key_makersuite_model) {\n\t\tif (!uniqueModels.has(secrets.api_key_makersuite_model)) {\n\t\t\treturn\n\t\t}\n\t\toai_settings.google_model = secrets.api_key_makersuite_model;\n\t\t$('#model_google_select').val(oai_settings.google_model);\n\t\t$(`#model_google_select option[value=\"${oai_settings.google_model}\"`).attr('selected', true);\n\t}\n\n}\n\nconst key = \"api_key_makersuite_custom\";\nasync function getSecrets() {\n\tconst response = await fetch(\"/api/secrets/view\", {\n\t\tmethod: \"POST\",\n\t\theaders: getRequestHeaders(),\n\t});\n\n\tif (response.status === 403) {\n\t\tcallGenericPopup(\n\t\t\t\"<h3>禁止访问</h3><p>要在此处查看您的 API 密钥，请在 config.yaml 文件中将 allowKeysExposure 的值设置为 true，然后重新启动 SillyTavern 服务器。</p>\",\n\t\t\tPOPUP_TYPE.TEXT\n\t\t);\n\t\treturn;\n\t}\n\n\tif (!response.ok) {\n\t\treturn;\n\t}\n\n\t// $(\"#dialogue_popup\").addClass(\"wide_dialogue_popup\");\n\tconst data = (await response.json()) as Record<string, string>;\n\t// console.log(\"data\", data);\n\treturn data;\n}\nasync function createButton(title: string, onClick: () => void) {\n\tconst div = document.createElement(\"div\");\n\tdiv.classList.add(\"menu_button\", \"menu_button_icon\", \"interactable\");\n\tdiv.title = title;\n\tdiv.onclick = onClick;\n\tconst span = document.createElement(\"span\");\n\tspan.textContent = title;\n\tdiv.appendChild(span);\n\treturn div;\n}\nasync function switchSecretsFromArray(generationType, _args, isDryRun) {\n\tconst secrets = await getSecrets();\n\tif (!secrets) {\n\t\treturn;\n\t}\n\tif (!switchState) {\n\t\treturn;\n\t}\n\tconst api_key = secrets[key] ?? \"\";\n\tconst api_keys = api_key\n\t\t.split(/[\\n;]/)\n\t\t.map((v) => v.trim())\n\t\t.filter((v) => v.startsWith(\"AIzaSy\"));\n\tif (api_keys.length <= 1) {\n\t\treturn;\n\t}\n\tconst currentKey = secrets.api_key_makersuite;\n\tlet firstKeyApi = \"\";\n\tif (api_keys.includes(currentKey)) {\n\t\tapi_keys.splice(api_keys.indexOf(currentKey), 1);\n\t\tapi_keys.push(currentKey);\n\t}\n\tfirstKeyApi = api_keys[0];\n\twriteSecret(\"api_key_makersuite\", firstKeyApi);\n\tsaveKey(key, api_keys.join(\"\\n\"));\n\tconst textarea = $(\"#api_key_makersuite_custom\")[0] as HTMLTextAreaElement;\n\n\tconst currentKeyElement = $(\"#current_key_maker_suite\")[0] as HTMLSpanElement;\n\tconst lastKeyElement = $(\"#last_key_maker_suite\")[0] as HTMLSpanElement;\n\tconsole.log(\"textarea\", textarea);\n\tconsole.log(\"api_keys\", api_keys);\n\tif (!textarea) {\n\t\treturn;\n\t}\n\tcurrentKeyElement.textContent = `当前密钥: ${firstKeyApi}`;\n\tlastKeyElement.textContent = `最后一个密钥: ${currentKey}`;\n\n\ttextarea.value = api_keys.join(\"\\n\");\n}\nasync function saveKey(key: string, value: string, isUpdateSecretDisplay = true) {\n\t// 设置密钥\n\tawait writeSecret(key, value);\n\t// 更新密钥显示\n\tif (isUpdateSecretDisplay) {\n\t\tupdateSecretDisplay();\n\t}\n\tupdateSecretDisplay();\n\t// 保存设置\n\tsaveSettingsDebounced();\n}\nconst GOOGLE_SOURCES = [\"makersuite\", \"google\"];\njQuery(async () => {\n\t// @ts-ignore\n\tconst oldError = toastr.error;\n\t// @ts-ignore\n\ttoastr.error = (/** @type { any[]} */ ...args) => {\n\n\t\toldError(...args);\n\t\tconsole.log(args);\n\t\tconsole.error(...args);\n\t\tif (!isGeminiSource() || !throwGeminiErrorState) {\n\t\t\treturn\n\t\t}\n\t\tconst [message, type] = args;\n\n\t\tif (!type) {\n\t\t\treturn\n\t\t}\n\t\tif (type === 'Chat Completion API') {\n\t\t\tconst lastKeyElement = $(\"#last_key_maker_suite\")[0] as HTMLSpanElement;\n\t\t\tthrowGeminiError(`<h3>Chat Completion API 错误</h3>\n\t\t\t\t<p>${message}</p>\n\t\t\t\t<p> ${lastKeyElement.textContent}</p>`);\n\t\t}\n\n\t};\n\n\t// 获取form元素 id为\"makersuite_form\"的元素 用jquery的选择器\n\tconst secrets = (await getSecrets()) ?? {};\n\tawait init(secrets);\n\tconst form = $(\"#makersuite_form\")[0];\n\t// 创建div元素添加类为\"flex-container flex\"的类\n\tconst flexContainer = document.createElement(\"div\");\n\tflexContainer.classList.add(\"flex-container\", \"flex\");\n\t// 添加h4元素 内容为\"Google AI Studio API 多个密钥\"\n\tconst h4 = document.createElement(\"h4\");\n\th4.textContent = \"Google AI Studio API 多个密钥\";\n\tflexContainer.appendChild(h4);\n\t// 创建textare元素添加类为\"text_pole textarea_compact autoSetHeight\"的类\n\tconst textarea = document.createElement(\"textarea\");\n\ttextarea.classList.add(\"text_pole\", \"textarea_compact\", \"autoSetHeight\");\n\t// 设置placeholder属性\n\ttextarea.placeholder = \"API密钥\";\n\t// 设置高度\n\ttextarea.style.height = \"100px\";\n\t// 添加id属性\n\ttextarea.id = \"api_key_makersuite_custom\";\n\t// 监听input事件\n\ttextarea.addEventListener(\"change\", () => {\n\t\tconst value = textarea.value\n\t\t\t.split(/[\\n;]/)\n\t\t\t.map((v) => v.trim())\n\t\t\t.filter((v) => v.length > 0 && v.startsWith(\"AIzaSy\"));\n\n\t\ttextarea.value = value.join(\"\\n\");\n\t\tif (value.length === 0) {\n\t\t\tsaveKey(key, value.join(\"\\n\"));\n\t\t\treturn;\n\t\t}\n\t\tconst fistValue = value[0];\n\t\twriteSecret(\"api_key_makersuite\", fistValue);\n\t\tsaveKey(key, value.join(\"\\n\"));\n\t});\n\ttextarea.value = secrets[key] || \"\";\n\tflexContainer.appendChild(textarea);\n\t// 创建div元素添加类为\"flex-container flex\"的类\n\tconst flexContainer2 = document.createElement(\"div\");\n\t// 添加h4元素 内容为\"当前和最后一个密钥\"\n\tconst h42 = document.createElement(\"h4\");\n\th42.textContent = \"密钥调用信息:\";\n\tflexContainer2.appendChild(h42);\n\t// 创建span元素\n\tconst span = document.createElement(\"div\");\n\t// 设置内容\n\tspan.textContent = `当前: ${secrets.api_key_makersuite}`;\n\t// 添加id属性 `current_key_maker_suite`\n\tspan.id = \"current_key_maker_suite\";\n\t// 创建span元素\n\tconst span2 = document.createElement(\"div\");\n\t// 设置内容\n\tspan2.textContent = `最后: ${secrets[key]?.split(\"\\n\").pop()}`;\n\t// 添加id属性 `last_key_maker_suite`\n\tspan2.id = \"last_key_maker_suite\";\n\tconst swtichDiv = document.createElement(\"div\");\n\t// 设置内容\n\tswtichDiv.textContent = `密钥切换:${switchState ? \"开\" : \"关\"}`;\n\t// 添加id属性 `last_key_maker_suite`\n\tswtichDiv.id = \"switch_key_maker_suite\";\n\tconst throwGeminiErrorDiv = document.createElement(\"div\");\n\t// 设置内容\n\tthrowGeminiErrorDiv.textContent = `报错开关:${throwGeminiErrorState ? \"开\" : \"关\"}`;\n\tthrowGeminiErrorDiv.id = \"throw_gemini_error\";\n\tflexContainer2.appendChild(span);\n\tflexContainer2.appendChild(span2);\n\tflexContainer2.appendChild(swtichDiv);\n\tform.appendChild(flexContainer2);\n\tform.appendChild(flexContainer);\n\tconst modelButton = await createButton(\"获取新的模型\", async () => {\n\t\tconst secrets = (await getSecrets()) ?? {};\n\t\tawait init(secrets);\n\t});\n\tconst saveButton = await createButton(\"保存密钥\", async () => {\n\t\tconst value = textarea.value\n\t\t\t.split(/[\\n;]/)\n\t\t\t.map((v) => v.trim())\n\t\t\t.filter((v) => v.length > 0 && v.startsWith(\"AIzaSy\"));\n\n\t\ttextarea.value = value.join(\"\\n\");\n\t\tif (value.length === 0) {\n\t\t\tsaveKey(key, value.join(\"\\n\"));\n\t\t\treturn;\n\t\t}\n\t\tconst fistValue = value[0];\n\t\twriteSecret(\"api_key_makersuite\", fistValue);\n\t\tsaveKey(key, value.join(\"\\n\"));\n\t});\n\n\tconst switchStateButton = await createButton(\"切换密钥设置\", async () => {\n\t\tswitchState = !switchState;\n\t\tlocalStorage.setItem(\"switch_key_maker_suite\", switchState.toString());\n\t\tswtichDiv.textContent = `密钥切换:${switchState ? \"开\" : \"关\"}`;\n\t});\n\n\tconst throwGeminiErrorButton = await createButton(\"查看报错原因\", async () => {\n\t\tthrowGeminiError();\n\t});\n\tconst throwGeminiErrorSwitchButton = await createButton(\"报错开关\", async () => {\n\t\tthrowGeminiErrorState = !throwGeminiErrorState;\n\t\tlocalStorage.setItem(\"throw_gemini_error\", throwGeminiErrorState.toString());\n\t\tthrowGeminiErrorDiv.textContent = `报错开关:${throwGeminiErrorState ? \"开\" : \"关\"}`;\n\t});\n\tconst div = document.createElement(\"div\");\n\tdiv.classList.add(\"flex-container\", \"flex\");\n\tdiv.appendChild(saveButton);\n\tdiv.appendChild(modelButton);\n\tdiv.appendChild(switchStateButton);\n\tdiv.appendChild(throwGeminiErrorButton);\n\tdiv.appendChild(throwGeminiErrorSwitchButton);\n\tform.appendChild(div);\n\t// 添加分割线\n\tform.appendChild(document.createElement(\"hr\"));\n\n\teventSource.on(\n\t\tevent_types.CHAT_COMPLETION_SETTINGS_READY,\n\t\tswitchSecretsFromArray,\n\t);\n\teventSource.on(event_types.CHATCOMPLETION_MODEL_CHANGED, async (model: string) => {\n\t\tif (isGeminiSource()) await saveKey(\"api_key_makersuite_model\", model);\n\t})\n});\n"],"names":["__webpack_require__","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","y","x","d","__WEBPACK_EXTERNAL_MODULE__script_js_588e7203__","__WEBPACK_EXTERNAL_MODULE__scripts_secrets_js_e26d24e7__","__WEBPACK_EXTERNAL_MODULE__scripts_openai_js_991751fb__","__WEBPACK_EXTERNAL_MODULE__scripts_popup_js_d782a329__","GEMINI_SOURCES","isGeminiSource","includes","oai_settings","chat_completion_source","throwGeminiError","text","arguments","length","undefined","callGenericPopup","concat","POPUP_TYPE","TEXT","large","wide","allowVerticalScrolling","switchState","localStorage","getItem","throwGeminiErrorState","async","init","secrets","_secrets$models_maker","_secrets$api_key_make","modelStr","JSON","parse","models_makersuite","api_key","api_key_makersuite","console","log","optgroup","$","primaryVersions","subVersions","subVersionsArray","Array","from","children","primaryVersionsArray","subVersionsValues","map","el","value","originalVersions","flat","cachedVersions","model","option","document","createElement","name","appendChild","geminiModels","result","fetch","data","json","models","filter","modelData","replace","displayName","e","error","getGeminiModel","geminiModelOptions","saveKey","stringify","uniqueModels","Set","GOOGLE_SOURCES","api_key_makersuite_model","has","google_model","val","attr","getSecrets","response","method","headers","getRequestHeaders","status","ok","createButton","title","onClick","div","classList","add","onclick","span","textContent","switchSecretsFromArray","generationType","_args","isDryRun","_secrets$key","api_keys","split","v","trim","startsWith","currentKey","firstKeyApi","splice","indexOf","push","writeSecret","join","textarea","currentKeyElement","lastKeyElement","isUpdateSecretDisplay","updateSecretDisplay","saveSettingsDebounced","jQuery","_await$getSecrets","_secrets$key2","oldError","toastr","_len","args","_key","message","type","form","flexContainer","h4","placeholder","style","height","id","addEventListener","fistValue","flexContainer2","h42","span2","pop","swtichDiv","throwGeminiErrorDiv","modelButton","_await$getSecrets2","saveButton","switchStateButton","setItem","toString","throwGeminiErrorButton","throwGeminiErrorSwitchButton","eventSource","on","event_types","CHAT_COMPLETION_SETTINGS_READY","CHATCOMPLETION_MODEL_CHANGED"],"sourceRoot":""}