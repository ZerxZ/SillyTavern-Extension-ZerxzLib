import*as e from"../../../../../script.js";import*as t from"../../../../../scripts/extensions.js";import*as n from"../../../../../scripts/secrets.js";var o={d:(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},a={};o.d(a,{A:()=>l});const s=(e=>{var t={};return o.d(t,e),t})({callPopup:()=>e.callPopup,eventSource:()=>e.eventSource,event_types:()=>e.event_types,getRequestHeaders:()=>e.getRequestHeaders,saveSettingsDebounced:()=>e.saveSettingsDebounced});const i=(e=>{var t={};return o.d(t,e),t})({extension_settings:()=>t.extension_settings});const r=(e=>{var t={};return o.d(t,e),t})({updateSecretDisplay:()=>n.updateSecretDisplay,writeSecret:()=>n.writeSecret}),c="SillyTavern-Extension-ZerxzLib";i.extension_settings[c];async function l(e){if(!e)return;const t=JSON.parse(e.models_makersuite??"[]"),n=e.api_key_makersuite??"";console.log("ZerxzLib init");const o=$("#model_google_select > optgroup");console.log("optgroup",o);const a=o[0],i=o[1];console.log("subVersions",i);const c=Array.from(i.children),l=Array.from(a.children);console.log("subVersionsArray",c);const d=c.map((e=>e.value)),u=[...l.map((e=>e.value)),...d,...t.map((e=>e.model))];if(t.length>0)for(const e of t){const t=document.createElement("option");t.value=e.model,t.text=e.name,i.appendChild(t)}console.log("subVersionsValues",d);const p=await async function(e){try{const t=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/?key=${e}`),n=await t.json();return console.log(n),n.models.filter((e=>e.name.includes("gemini"))).map((e=>{const t=e.name.replace("models/","");return{name:e.displayName,model:t}}))}catch(e){return console.error(e),[]}}(n);console.log("geminiModels",p);const m=p.filter((e=>!u.includes(e.model)));if(0!==m.length){console.log("geminiModelOptions",m);for(const e of m){const t=document.createElement("option");t.value=e.model,t.text=e.name,i.appendChild(t)}(0,r.writeSecret)("models_makersuite",JSON.stringify(m)),(0,r.updateSecretDisplay)(),(0,s.saveSettingsDebounced)()}}const d="api_key_makersuite_custom";async function u(){const e=await fetch("/api/secrets/view",{method:"POST",headers:(0,s.getRequestHeaders)()});if(403===e.status)return void(0,s.callPopup)("<h3>禁止访问</h3><p>要在此处查看您的 API 密钥，请在 config.yaml 文件中将 allowKeysExposure 的值设置为 true，然后重新启动 SillyTavern 服务器。</p>","text");if(!e.ok)return;const t=await e.json();return console.log("data",t),t}async function p(e,t){const n=document.createElement("div");n.classList.add("menu_button","menu_button_icon","interactable"),n.title=e,n.onclick=t;const o=document.createElement("span");return o.textContent=e,n.appendChild(o),n}async function m(e,t,n){const o=await u();if(!o)return;const a=(o[d]??"").split(/[\n;]/).map((e=>e.trim())).filter((e=>e.length>0&&e.startsWith("AIzaSy")));if(0===a.length)return;const s=o.api_key_makersuite;let i="";a.includes(s)&&(a.splice(a.indexOf(s),1),a.push(s),i=a[0],(0,r.writeSecret)("api_key_makersuite",i),_(d,a.join("\n")));const c=$("#api_key_makersuite_custom")[0],l=$("#current_key_maker_suite")[0],p=$("#last_key_maker_suite")[0];console.log("textarea",c),console.log("api_keys",a),c&&(l.textContent=`当前密钥: ${i}`,p.textContent=`最后一个密钥: ${s}`,c.value=a.join("\n"))}async function _(e,t){(0,r.writeSecret)(e,t),(0,r.updateSecretDisplay)(),(0,s.saveSettingsDebounced)()}jQuery((async()=>{const e=await u()??{};await l(e);const t=$("#makersuite_form")[0],n=document.createElement("div");n.classList.add("flex-container","flex");const o=document.createElement("h4");o.textContent="Google AI Studio API 多个密钥",n.appendChild(o);const a=document.createElement("textarea");a.classList.add("text_pole","textarea_compact","autoSetHeight"),a.placeholder="API密钥",a.style.height="100px",a.id="api_key_makersuite_custom",a.addEventListener("change",(()=>{const e=a.value.split(/[\n;]/).map((e=>e.trim())).filter((e=>e.length>0&&e.startsWith("AIzaSy")));if(a.value=e.join("\n"),0===e.length)return void _(d,e.join("\n"));const t=e[0];(0,r.writeSecret)("api_key_makersuite",t),_(d,e.join("\n"))})),a.value=e[d]||"",n.appendChild(a);const i=document.createElement("div"),c=document.createElement("h4");c.textContent="密钥调用信息:",i.appendChild(c);const y=document.createElement("div");y.textContent=`当前: ${e.api_key_makersuite}`,y.id="current_key_maker_suite";const g=document.createElement("div");g.textContent=`最后: ${e[d]?.split("\n").pop()}`,g.id="last_key_maker_suite",i.appendChild(y),i.appendChild(g),t.appendChild(i),t.appendChild(n);const h=await p("获取新的模型",(async()=>{const e=await u()??{};await l(e)})),f=await p("保存密钥",(async()=>{const e=a.value.split(/[\n;]/).map((e=>e.trim())).filter((e=>e.length>0&&e.startsWith("AIzaSy")));if(a.value=e.join("\n"),0===e.length)return void _(d,e.join("\n"));const t=e[0];(0,r.writeSecret)("api_key_makersuite",t),_(d,e.join("\n"))})),v=document.createElement("div");v.classList.add("flex-container","flex"),v.appendChild(f),v.appendChild(h),t.appendChild(v),t.appendChild(document.createElement("hr")),s.eventSource.on(s.event_types.CHAT_COMPLETION_SETTINGS_READY,m)}));var y=a.A;export{y as default};
//# sourceMappingURL=zerxzLib.js.map