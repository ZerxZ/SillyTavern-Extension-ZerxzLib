import*as e from"../../../../../script.js";import*as t from"../../../../../scripts/extensions.js";import*as n from"../../../../../scripts/secrets.js";var o={d:(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},a={};o.d(a,{A:()=>d});const s=(e=>{var t={};return o.d(t,e),t})({callPopup:()=>e.callPopup,eventSource:()=>e.eventSource,event_types:()=>e.event_types,getRequestHeaders:()=>e.getRequestHeaders,saveSettingsDebounced:()=>e.saveSettingsDebounced});const i=(e=>{var t={};return o.d(t,e),t})({extension_settings:()=>t.extension_settings});const r=(e=>{var t={};return o.d(t,e),t})({updateSecretDisplay:()=>n.updateSecretDisplay,writeSecret:()=>n.writeSecret}),c="SillyTavern-Extension-ZerxzLib";i.extension_settings[c];let l="true"===localStorage.getItem("switch_key_maker_suite");async function d(e){if(!e)return;if(!l)return;const t=JSON.parse(e.models_makersuite??"[]"),n=e.api_key_makersuite??"";console.log("ZerxzLib init");const o=$("#model_google_select > optgroup");console.log("optgroup",o);const a=o[0],i=o[1];console.log("subVersions",i);const c=Array.from(i.children),d=Array.from(a.children);console.log("subVersionsArray",c);const u=c.map((e=>e.value)),p=[...d.map((e=>e.value)),...u].flat(),m=t.map((e=>e.model));if(t.length>0)for(const e of t){if(p.includes(e.model))continue;const t=document.createElement("option");t.value=e.model,t.text=`${e.name}(${e.model})`,i.appendChild(t)}const _=await async function(e){try{const t=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/?key=${e}`),n=await t.json();return console.log(n),n.models.filter((e=>e.name.includes("gemini"))).map((e=>{const t=e.name.replace("models/","");return{name:e.displayName,model:t}}))}catch(e){return console.error(e),[]}}(n);console.log("geminiModels",_);const y=_.filter((e=>!p.includes(e.model)&&!m.includes(e.model)));if(0!==y.length){console.log("geminiModelOptions",y);for(const e of y){const t=document.createElement("option");t.value=e.model,t.text=`${e.name}(${e.model})`,i.appendChild(t)}(0,r.writeSecret)("models_makersuite",JSON.stringify(y)),(0,r.updateSecretDisplay)(),(0,s.saveSettingsDebounced)()}else console.log("没有新的模型")}const u="api_key_makersuite_custom";async function p(){const e=await fetch("/api/secrets/view",{method:"POST",headers:(0,s.getRequestHeaders)()});if(403===e.status)return void(0,s.callPopup)("<h3>禁止访问</h3><p>要在此处查看您的 API 密钥，请在 config.yaml 文件中将 allowKeysExposure 的值设置为 true，然后重新启动 SillyTavern 服务器。</p>","text");if(!e.ok)return;return await e.json()}async function m(e,t){const n=document.createElement("div");n.classList.add("menu_button","menu_button_icon","interactable"),n.title=e,n.onclick=t;const o=document.createElement("span");return o.textContent=e,n.appendChild(o),n}async function _(e,t,n){const o=await p();if(!o)return;const a=(o[u]??"").split(/[\n;]/).map((e=>e.trim())).filter((e=>e.startsWith("AIzaSy")));if(a.length<=1)return;const s=o.api_key_makersuite;let i="";a.includes(s)&&(a.splice(a.indexOf(s),1),a.push(s)),i=a[0],(0,r.writeSecret)("api_key_makersuite",i),y(u,a.join("\n"));const c=$("#api_key_makersuite_custom")[0],l=$("#current_key_maker_suite")[0],d=$("#last_key_maker_suite")[0];console.log("textarea",c),console.log("api_keys",a),c&&(l.textContent=`当前密钥: ${i}`,d.textContent=`最后一个密钥: ${s}`,c.value=a.join("\n"))}async function y(e,t){(0,r.writeSecret)(e,t),(0,r.updateSecretDisplay)(),(0,s.saveSettingsDebounced)()}jQuery((async()=>{const e=await p()??{};await d(e);const t=$("#makersuite_form")[0],n=document.createElement("div");n.classList.add("flex-container","flex");const o=document.createElement("h4");o.textContent="Google AI Studio API 多个密钥",n.appendChild(o);const a=document.createElement("textarea");a.classList.add("text_pole","textarea_compact","autoSetHeight"),a.placeholder="API密钥",a.style.height="100px",a.id="api_key_makersuite_custom",a.addEventListener("change",(()=>{const e=a.value.split(/[\n;]/).map((e=>e.trim())).filter((e=>e.length>0&&e.startsWith("AIzaSy")));if(a.value=e.join("\n"),0===e.length)return void y(u,e.join("\n"));const t=e[0];(0,r.writeSecret)("api_key_makersuite",t),y(u,e.join("\n"))})),a.value=e[u]||"",n.appendChild(a);const i=document.createElement("div"),c=document.createElement("h4");c.textContent="密钥调用信息:",i.appendChild(c);const g=document.createElement("div");g.textContent=`当前: ${e.api_key_makersuite}`,g.id="current_key_maker_suite";const h=document.createElement("div");h.textContent=`最后: ${e[u]?.split("\n").pop()}`,h.id="last_key_maker_suite";const f=document.createElement("div");f.textContent="密钥切换:"+(l?"开":"关"),f.id="switch_key_maker_suite",i.appendChild(g),i.appendChild(h),i.appendChild(f),t.appendChild(i),t.appendChild(n);const v=await m("获取新的模型",(async()=>{const e=await p()??{};await d(e)})),k=await m("保存密钥",(async()=>{const e=a.value.split(/[\n;]/).map((e=>e.trim())).filter((e=>e.length>0&&e.startsWith("AIzaSy")));if(a.value=e.join("\n"),0===e.length)return void y(u,e.join("\n"));const t=e[0];(0,r.writeSecret)("api_key_makersuite",t),y(u,e.join("\n"))})),S=await m("切换密钥设置",(async()=>{l=!l,localStorage.setItem("switch_key_maker_suite",l.toString()),f.textContent="密钥切换:"+(l?"开":"关")})),x=document.createElement("div");x.classList.add("flex-container","flex"),x.appendChild(k),x.appendChild(v),x.appendChild(S),t.appendChild(x),t.appendChild(document.createElement("hr")),s.eventSource.on(s.event_types.CHAT_COMPLETION_SETTINGS_READY,_)}));var g=a.A;export{g as default};
//# sourceMappingURL=zerxzLib.js.map