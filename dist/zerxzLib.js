import*as t from"../../../../../script.js";import*as e from"../../../../../scripts/secrets.js";import*as n from"../../../../../scripts/openai.js";import*as o from"../../../../../scripts/popup.js";var a={d:(t,e)=>{for(var n in e)a.o(e,n)&&!a.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},r={};a.d(r,{A:()=>h});const i=(t=>{var e={};return a.d(e,t),e})({eventSource:()=>t.eventSource,event_types:()=>t.event_types,getRequestHeaders:()=>t.getRequestHeaders,saveSettingsDebounced:()=>t.saveSettingsDebounced});const s=(t=>{var e={};return a.d(e,t),e})({updateSecretDisplay:()=>e.updateSecretDisplay,writeSecret:()=>e.writeSecret});const l=(t=>{var e={};return a.d(e,t),e})({oai_settings:()=>n.oai_settings});const c=(t=>{var e={};return a.d(e,t),e})({POPUP_TYPE:()=>o.POPUP_TYPE,callGenericPopup:()=>o.callGenericPopup});const d=["makersuite","aistudio"],u=()=>d.includes(l.oai_settings.chat_completion_source);function p(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";(0,c.callGenericPopup)("\n\t\t\t\t".concat(t,'\n\t\t\t\t<table class="responsiveTable">\n\t\t\t\t\t<thead>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<th>报错</th>\n\t\t\t\t\t\t\t<th>原因或解决方案</th>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</thead>\n\t\t\t\t\t<tbody>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>429/Resource has been exhausted</td>\n\t\t\t\t\t\t\t<td>撞到速率上限了，请等一会，若还是出现此报错请将最大上下文调整至 50k 以下</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Internal Server Error</td>\n\t\t\t\t\t\t\t<td>手机端遇到请换成 clash，不要使用类如**VPN、** 加速器等第三方梯子软件，pc 端用户请打开服务模式和 tun 模式，若仍出现此报错需要检查一下反向代理-代理地址中是否留空，若有地址请删掉</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>User location is not supported for the API use.</td>\n\t\t\t\t\t\t\t<td>节点处于被限制的国家，请更换节点(美国最优先，请勿选择欧洲、中国香港、俄罗斯等地区)</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Too Many Requests</td>\n\t\t\t\t\t\t\t<td>重刷过于频繁，等待一分钟，若无效则本日请求已达上限</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Bad request</td>\n\t\t\t\t\t\t\t<td>网络环境出错或 API 已死（账号或项目被封禁）</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>API key expired. Please renew the API key</td>\n\t\t\t\t\t\t\t<td>API key 已过期或被删除</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>The model is overloaded. Please try later</td>\n\t\t\t\t\t\t\t<td>此模型暂时闭馆微调，暂停开放，请换用别的模型或等待一段时间</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Please use a valid role: user, model.</td>\n\t\t\t\t\t\t\t<td>你使用了需要打补丁的预设，请换不需要补丁的预设或打补丁</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>User location is not supported for the API use without a billing account linked.</td>\n\t\t\t\t\t\t\t<td>处在 Google 政策限制免费层级的地区(如英国、意大利)</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>API key not valid. Please pass a valid API key</td>\n\t\t\t\t\t\t\t<td>API 返回错误，检查 API 是否可用</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Permission denied: Consumer has been suspended.</td>\n\t\t\t\t\t\t\t<td>谷歌账号被封禁</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>MakerSuite API returned no candidate</td>\n\t\t\t\t\t\t\t<td>Prompt was blocked due to : OTHER 本次输出被截断，请关闭流式传输</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Not Found</td>\n\t\t\t\t\t\t\t<td>模型选择错误，请不要选择除 Gemini 系外的模型或 Gemini Ultra</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>MakerSuite Candidate text empty</td>\n\t\t\t\t\t\t\t<td>还是截断，解决方法有很多，关闭一些全局世界书/更改输入内容/换版本更新一点的预设</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>403/Forbidden</td>\n\t\t\t\t\t\t\t<td>账号或项目被封禁，API key 无法调用</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</tbody>\n\t\t\t\t</table>\n\n\t\t\t\t<h2>出现其它未知报错无法解决请在群内(433695739)提问</h2>\n\t\t\t'),c.POPUP_TYPE.TEXT,"",{large:!0,wide:!0,allowVerticalScrolling:!0})}let m="true"===localStorage.getItem("switch_key_maker_suite"),_="true"!==localStorage.getItem("throw_gemini_error");async function h(t){var e,n;if(!t)return;const o=JSON.parse(null!==(e=t.models_makersuite)&&void 0!==e?e:"[]"),a=null!==(n=t.api_key_makersuite)&&void 0!==n?n:"";console.log("ZerxzLib init");const r=$("#model_google_select > optgroup");console.log("optgroup",r);const i=r[0],s=r[1];console.log("subVersions",s);const c=Array.from(s.children),d=Array.from(i.children);console.log("subVersionsArray",c);const u=c.map((t=>t.value)),p=[...d.map((t=>t.value)),...u].flat(),m=o.map((t=>t.model));if(o.length>0)for(const t of o){if(p.includes(t.model))continue;const e=document.createElement("option");e.value=t.model,e.text="".concat(t.name,"(").concat(t.model,")"),s.appendChild(e)}const _=await async function(t){try{const e=await fetch("https://generativelanguage.googleapis.com/v1beta/models/?key=".concat(t)),n=await e.json();return null!=n&&n.models?(console.log(n),n.models.filter((t=>t.name.includes("gemini"))).map((t=>{const e=t.name.replace("models/","");return{name:t.displayName,model:e}}))):[]}catch(t){return console.error(t),[]}}(a);console.log("geminiModels",_);const h=_.filter((t=>!p.includes(t.model)&&!m.includes(t.model)));if(0===h.length)console.log("没有新的模型");else{console.log("geminiModelOptions",h);for(const t of h){const e=document.createElement("option");e.value=t.model,e.text="".concat(t.name,"(").concat(t.model,")"),s.appendChild(e)}f("models_makersuite",JSON.stringify(h))}const g=new Set([...p,...m,...h.map((t=>t.model))]);if(P.includes(l.oai_settings.chat_completion_source)&&t.api_key_makersuite_model){if(!g.has(t.api_key_makersuite_model))return;l.oai_settings.google_model=t.api_key_makersuite_model,$("#model_google_select").val(l.oai_settings.google_model),$('#model_google_select option[value="'.concat(l.oai_settings.google_model,'"')).attr("selected",!0)}}const g="api_key_makersuite_custom";async function y(){const t=await fetch("/api/secrets/view",{method:"POST",headers:(0,i.getRequestHeaders)()});if(403===t.status)return void(0,c.callGenericPopup)("<h3>禁止访问</h3><p>要在此处查看您的 API 密钥，请在 config.yaml 文件中将 allowKeysExposure 的值设置为 true，然后重新启动 SillyTavern 服务器。</p>",c.POPUP_TYPE.TEXT);if(!t.ok)return;return await t.json()}async function v(t,e){const n=document.createElement("div");n.classList.add("menu_button","menu_button_icon","interactable"),n.title=t,n.onclick=e;const o=document.createElement("span");return o.textContent=t,n.appendChild(o),n}async function k(t,e,n){var o;const a=await y();if(!a)return;if(!m)return;const r=(null!==(o=a[g])&&void 0!==o?o:"").split(/[\n;]/).map((t=>t.trim())).filter((t=>t.startsWith("AIzaSy")));if(r.length<=1)return;const i=a.api_key_makersuite;let l="";r.includes(i)&&(r.splice(r.indexOf(i),1),r.push(i)),l=r[0],(0,s.writeSecret)("api_key_makersuite",l),f(g,r.join("\n"));const c=$("#api_key_makersuite_custom")[0],d=$("#current_key_maker_suite")[0],u=$("#last_key_maker_suite")[0];console.log("textarea",c),console.log("api_keys",r),c&&(d.textContent="当前密钥: ".concat(l),u.textContent="最后一个密钥: ".concat(i),c.value=r.join("\n"))}async function f(t,e){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];await(0,s.writeSecret)(t,e),n&&(0,s.updateSecretDisplay)(),(0,s.updateSecretDisplay)(),(0,i.saveSettingsDebounced)()}const P=["makersuite","google"];jQuery((async()=>{var t,e;const n=toastr.error;toastr.error=function(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];if(n(...e),console.log(e),console.error(...e),!u()||!_)return;const[a,r]=e;if(r&&"Chat Completion API"===r){const t=$("#last_key_maker_suite")[0];p("<h3>Chat Completion API 错误</h3>\n\t\t\t\t<p>".concat(a,"</p>\n\t\t\t\t<p> ").concat(t.textContent,"</p>"))}};const o=null!==(t=await y())&&void 0!==t?t:{};await h(o);const a=$("#makersuite_form")[0],r=document.createElement("div");r.classList.add("flex-container","flex");const l=document.createElement("h4");l.textContent="Google AI Studio API 多个密钥",r.appendChild(l);const c=document.createElement("textarea");c.classList.add("text_pole","textarea_compact","autoSetHeight"),c.placeholder="API密钥",c.style.height="100px",c.id="api_key_makersuite_custom",c.addEventListener("change",(()=>{const t=c.value.split(/[\n;]/).map((t=>t.trim())).filter((t=>t.length>0&&t.startsWith("AIzaSy")));if(c.value=t.join("\n"),0===t.length)return void f(g,t.join("\n"));const e=t[0];(0,s.writeSecret)("api_key_makersuite",e),f(g,t.join("\n"))})),c.value=o[g]||"",r.appendChild(c);const d=document.createElement("div"),P=document.createElement("h4");P.textContent="密钥调用信息:",d.appendChild(P);const C=document.createElement("div");C.textContent="当前: ".concat(o.api_key_makersuite),C.id="current_key_maker_suite";const w=document.createElement("div");w.textContent="最后: ".concat(null===(e=o[g])||void 0===e?void 0:e.split("\n").pop()),w.id="last_key_maker_suite";const S=document.createElement("div");S.textContent="密钥切换:".concat(m?"开":"关"),S.id="switch_key_maker_suite";const A=document.createElement("div");A.textContent="报错开关:".concat(_?"开":"关"),A.id="throw_gemini_error",d.appendChild(C),d.appendChild(w),d.appendChild(S),a.appendChild(d),a.appendChild(r);const E=await v("获取新的模型",(async()=>{var t;const e=null!==(t=await y())&&void 0!==t?t:{};await h(e)})),x=await v("保存密钥",(async()=>{const t=c.value.split(/[\n;]/).map((t=>t.trim())).filter((t=>t.length>0&&t.startsWith("AIzaSy")));if(c.value=t.join("\n"),0===t.length)return void f(g,t.join("\n"));const e=t[0];(0,s.writeSecret)("api_key_makersuite",e),f(g,t.join("\n"))})),I=await v("切换密钥设置",(async()=>{m=!m,localStorage.setItem("switch_key_maker_suite",m.toString()),S.textContent="密钥切换:".concat(m?"开":"关")})),b=await v("查看报错原因",(async()=>{p()})),T=await v("报错开关",(async()=>{_=!_,localStorage.setItem("throw_gemini_error",_.toString()),A.textContent="报错开关:".concat(_?"开":"关")})),O=document.createElement("div");O.classList.add("flex-container","flex"),O.appendChild(x),O.appendChild(E),O.appendChild(I),O.appendChild(b),O.appendChild(T),a.appendChild(O),a.appendChild(document.createElement("hr")),i.eventSource.on(i.event_types.CHAT_COMPLETION_SETTINGS_READY,k),i.eventSource.on(i.event_types.CHATCOMPLETION_MODEL_CHANGED,(async t=>{u()&&await f("api_key_makersuite_model",t)}))}));var C=r.A;export{C as default};
//# sourceMappingURL=zerxzLib.js.map